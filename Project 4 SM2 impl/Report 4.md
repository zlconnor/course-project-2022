## 原理分析

### ECC加密算法

#### 椭圆曲线离散对数问题（ECDLP）

椭圆曲线上的两个点$P$和$Q$，$k$为整数。
$$
Q=kP
$$
椭圆曲线加密的数学原理：点$P$称为基点；$k$为私钥；$Q$为公钥。

* 给定$k$和$P$，根据加法法则，计算$Q$很容易。
* 给定$P$和$Q$，求$k$非常困难。

椭圆曲线：$y^2=x^3+ax+b(4a^3+27b^2\neq 0)$**【描述方程与计算椭圆周长的方程类似】**

> 关于x轴对称，不存在奇点（处处有切线）。

<img src="F:\typora_img\image-20220722194608839.png" alt="image-20220722194608839" style="zoom:50%;" /><img src="F:\typora_img\image-20220722194621132.png" alt="image-20220722194621132" style="zoom:50%;" />

<img src="F:\typora_img\image-20220722194701821.png" alt="image-20220722194701821" style="zoom:50%;" /><img src="F:\typora_img\image-20220722194740312.png" alt="image-20220722194740312" style="zoom:50%;" />

#### ECC过程

1. 选一条椭圆曲线$Ep(a,b)$，并取椭圆曲线上一点作为**基点**$P$
2. 选择一个大数$k$作为**私钥**，并生成公钥$Q=kP$
3. 加密：选择**随机数$r$**，将消息$M$生成密文$C$，密文是一个点对即$C=(rP,M+rQ)$
4. 解密：$M+rQ-k(rP)=M+r(kP)-k(rP)=M$

椭圆曲线是连续的，并不适合加密，要将椭圆曲线变成离散的点，因此把椭圆曲线定义在**有限域**上。

> 如果域F只包含有限个元素则称其为有限域。
>
> 有限域中元素的个数称为有限域的阶。
>
> 每个有限域的阶必为素数的幂，即有限域的阶可表示为$p^n$
>
> 该有限域通常称为Galois域，记作$GF(p^n)$。
>
> 在域的定义上，作如下修改：
>
> 1. 定义模$p$加法和模$p$乘法
> 2. 集合内的元素经过加法和乘法计算结果仍在集合内==（封闭性）==
> 3. 计算符合==交换律、结合律、分配律==
> 4. 加法和乘法有==单位元==

有限域上的椭圆曲线运算：

<img src="F:\typora_img\image-20220722200112600.png" alt="image-20220722200112600" style="zoom: 67%;" /><img src="F:\typora_img\image-20220722200123290.png" alt="image-20220722200123290" style="zoom:67%;" />

<img src="F:\typora_img\image-20220722200130318.png" alt="image-20220722200130318" style="zoom:67%;" />

### SM2

#### 加密算法及流程

##### 加密算法

设需要发送的消息为比特串$M$，$klen$为M的比特长度。

1. 用随机数发生器产生随机数$k\in[1,n-1]$

2. 计算椭圆曲线点$C_1=[k]G=(x_1,y_1)$，将$C_1$的**数据类型转换为比特串**

3. 计算椭圆曲线点$S=[h]P_B$，若$S$是无穷远点则报错并退出

4. 计算椭圆曲线点$[k]P_B=(x_2,y_2)$并将其**数据类型转换为比特串**

5. 计算$t=KDF(x_2||y_2,klen)$【**密钥派生函数**】，若$t$为全0比特串则返回第一步

   > 密钥派生函数用于从一个共享的秘密比特串中派生出密钥数据。
   >
   > 在密钥协商过程中，密钥派生函数作用在密钥交换所获共享的秘密比特串上，从中产生所需的会话密钥或进一步加密所需的密钥数据。
   >
   > ![image-20220722202114529](F:\typora_img\image-20220722202114529.png)

6. 计算$C_2=M\oplus t$

7. 计算$C_3=Hash(x_2||M||y_2)$

8. 输出密文$C=C_1||C_2||C_3$



